<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-colors-design/colors.html" />
<link rel="import" href="../px-vis/px-vis-behavior-common.html" />
<link rel="import" href="../px-vis/px-vis-behavior-d3.html" />
<link rel="import" href="../px-vis/px-vis-behavior-chart.html" />
<link rel="import" href="../px-vis/px-vis-svg.html"/>
<link rel="import" href="../px-vis/px-vis-line.html"/>
<link rel="import" href="../px-vis/px-vis-scatter.html"/>
<link rel="import" href="../px-vis/px-vis-event.html"/>
<link rel="import" href="../px-vis/px-vis-axis.html"/>
<link rel="import" href="../px-vis/px-vis-gridlines.html"/>
<link rel="import" href="../px-vis/px-vis-data.html"/>
<link rel="import" href="../px-vis/px-vis-chart-navigator.html"/>
<link rel="import" href="../px-vis/px-vis-scale.html"/>
<link rel="import" href="../px-vis/px-vis-interaction-space.html"/>
<link rel="import" href="../px-vis/px-vis-cursor.html"/>
<link rel="import" href="../px-vis/px-vis-tooltip.html"/>
<link rel="import" href="../px-vis/px-vis-register.html"/>
<link rel="import" href="../px-vis/px-vis-threshold.html"/>
<link rel="import" href="../px-vis/px-vis-zoom.html"/>


<!--
Creates an interactive timeseries chart

##### Usage

    <px-vis-timeseries options='{ ... }'></px-vis-timeseries>

@element px-vis-timeseries
@blurb Creates an interactive timeseries chart
@homepage index.html
@demo demo.html
-->
<dom-module id="px-vis-timeseries">
  <link rel="import" type="css" href="css/px-vis-timeseries.css"/>
  <template>
    <div class="flex flex--row u-m">
      <div class="flex flex--col" style$="width:[[width]]px;">
        <px-vis-data
          id = "seriesAjax"
          request-data = "[[series]]"
          data-var="chartData"
          lists="append">
        </px-vis-data>
        <px-vis-data
          id = "eventAjax"
          request-data = "[[events]]"
          data-var="eventData"
          lists = "flat">
        </px-vis-data>
        <px-vis-data
          id = "thresholdAjax"
          request-data = "[[thresholds]]"
          data-var="thresholdData"
          lists = "flat">
        </px-vis-data>
        <template is="dom-if" if="[[_topRegister(registerLocation)]]">
          <px-vis-register
            height="50"
            width="[[width]]"
            type="horizontal"
            tooltip-data=[[tooltipData]]
            muted-series="[[mutedSeries]]">
          </px-vis-register>
        </template>
        <px-vis-scale
          x-scale="time"
          y-scale="linear"
          width="[[width]]"
          height="[[height]]"
          margin="[[margin]]"
          chart-data="[[chartData]]"
          selected-domain="[[selectedDomain]]">
        </px-vis-scale>
        <px-vis-svg
          width="[[width]]"
          height="[[height]]"
          margin="[[margin]]">
        </px-vis-svg>

        <template is="dom-repeat" items="[[chartData]]">
          <template is="dom-if" if="[[_chartTypeLine(item.type)]]">
            <px-vis-line
              svg="[[svg]]"
              series-id="[[item.name]]"
              series-number="[[item.seriesNumber]]"
              chart-data="[[item]]"
              x="[[x]]"
              y="[[y]]"
              current-domain-x="[[currentDomainX]]"
              current-domain-y="[[currentDomainY]]"
              muted-series="[[mutedSeries]]">
            </px-vis-line>
          </template>
          <template is="dom-if" if="[[_chartTypeScatter(item.type)]]">
            <px-vis-scatter
              svg="[[svg]]"
              series-id="[[item.name]]"
              series-number="[[item.seriesNumber]]"
              chart-data="[[item]]"
              x="[[x]]"
              y="[[y]]"
              current-domain-x="[[currentDomainX]]"
              current-domain-y="[[currentDomainY]]"
              muted-series="[[mutedSeries]]">
            </px-vis-scatter>
          </template>
        </template>

        <template is="dom-repeat" items="[[eventData]]">
          <px-vis-event
            svg="[[svg]]"
            event-id="[[item.id]]"
            chart-data="[[item]]"
            x="[[x]]"
            y="[[y]]"
            event-config="[[eventConfig]]"
            current-domain-x="[[currentDomainX]]"
            current-domain-y="[[currentDomainY]]">
          </px-vis-event>
        </template>

        <px-vis-threshold
          svg="[[svg]]"
          chart-data="[[thresholdData]]"
          x="[[x]]"
          y="[[y]]"
          current-domain-x="[[currentDomainX]]"
          current-domain-y="[[currentDomainY]]">
        </px-vis-threshold>

        <px-vis-gridlines
          svg="[[svg]]"
          axis="[[x]]"
          margin="[[margin]]"
          length="[[height]]"
          orientation="bottom"
          current-domain="[[currentDomainX]]">
        </px-vis-gridlines>

        <px-vis-gridlines
          svg="[[svg]]"
          axis="[[y]]"
          margin="[[margin]]"
          length="[[width]]"
          orientation="left"
          current-domain="[[currentDomainY]]">
        </px-vis-gridlines>

        <px-vis-axis
          svg="[[svg]]"
          axis="[[x]]"
          margin="[[margin]]"
          title="Date"
          orientation="bottom"
          label-position="after"
          current-domain="[[currentDomainX]]">
        </px-vis-axis>
        <px-vis-axis
          svg="[[svg]]"
          axis="[[y]]"
          margin="[[margin]]"
          title="Hz"
          orientation="left"
          chart-data=[[chartData]]
          muted-series=[[mutedSeries]]
          current-domain="[[currentDomainY]]">
        </px-vis-axis>

        <px-vis-interaction-space
          svg="[[svg]]"
          width="[[width]]"
          height="[[height]]"
          margin="[[margin]]"
          chart-data="[[chartData]]"
          x="[[x]]"
          y="[[y]]"
          current-domain-x="[[currentDomainX]]"
          current-domain-y="[[currentDomainY]]">
        </px-vis-interaction-space>

        <px-vis-cursor
          svg="[[svg]]"
          width="[[width]]"
          height="[[height]]"
          margin="[[margin]]"
          chart-data="[[chartData]]"
          horizontal-line="full"
          vertical-line="full"
          circle-point="yes"
          tooltip-data="[[tooltipData]]">
        </px-vis-cursor>

        <px-vis-chart-navigator
          x-scale="time"
          y-scale="linear"
          width="[[width]]"
          height="100"
          margin="[[marginNav]]"
          chart-data="[[chartData]]"
          nav-series-limit="[[navSeriesLimit]]"
          chart-domain-x="[[currentDomainX]]"
          chart-domain-y="[[currentDomainY]]"
          selected-domain="[[selectedDomain]]">
        </px-vis-chart-navigator>
      </div>
      <px-vis-zoom
        svg="[[svg]]"
        margin="[[margin]]"
        extents-data="[[extentsData]]">
      </px-vis-zoom>
      <template is="dom-if" if="[[enableTooltip]]">
        <px-vis-tooltip
          svg="[[svg]]"
          width="250"
          margin="[[margin]]"
          chart-data="[[chartData]]"
          tooltip-data="[[tooltipData]]">
        </px-vis-tooltip>
      </template>
      <template is="dom-if" if="[[_sideRegister(registerLocation)]]">
        <px-vis-register
          height="[[height]]"
          units="Hz"
          tooltip-data=[[tooltipData]]
          muted-series="[[mutedSeries]]">
        </px-vis-register>
      </template>
    </div>
  </template>
</dom-module>

<script>
    Polymer({

        is: 'px-vis-timeseries',

        behaviors: [
          PxVisBehavior.sizing,
          PxVisBehavior.formatting,
          PxVisBehavior.mutedSeries,
          PxVisBehavior.tooltipData,
          PxVisBehavior.extentsData,
          PxVisBehavior.datetime,
          PxVisBehavior.svg,
          PxVisBehavior.axes,
          PxVisBehavior.axis,
          PxVisBehavior.selectedDomain,
          PxVisBehavior.dataset,
          PxVisBehavior.chartCommon,
          PxVisBehavior.interaction,
          commonColors
        ],

        /**
         * Properties block, expose attribute values to the DOM via 'reflect'
         *
         * @property properties
         * @type Object
         */
        properties: {
          /**
           *
           *
           *
           * @type Array
           */
          series:{
            type:Array
          },
          /**
           *
           *
           *
           * @type Array
           */
          events:{
            type:Array
          },
          /**
           *
           *
           *
           * @type Array
           */
          thresholds:{
            type:Array
          },
          /**
           * Defines where to locate the X-axis.
           * - `bottom`
           * - `top`
           *
           * @property xAxisLocation
           * @type String
           * @default bottom
           */
          xAxisLocation:{
            type:String,
            value:'bottom'
          },
          /**
           * Defines where to locate the Y-axis.
           * - `left`
           * - `right`
           *
           * @property yAxisLocation
           * @type String
           * @default left
           */
          yAxisLocation:{
            type:String,
            value:'left'
          },
          /**
           * Defines the base margin for the navigator.
           *
           * @property marginNav
           * @type Object
           * @default { top: 5, right: 5, bottom: 5, left: 5}
           * @private
           */
          marginNav:{
            type:Object,
            value: { top: 5, right: 5, bottom: 5, left: 5},
          },
          /**
           * Defines where the register will appear. Valid entries are`:
           * - 'none'
           * - 'top'
           * - 'side'
           * - 'both'
           *
           * @property registerLocation
           * @type string
           * @default side
          */
          registerLocation:{
            type:String,
            value:'side'
          },
          /**
           * Configuration object for the chart. Key is the property name.
           *
           * @property options
           * @type Object
          */
          options:{
            type:Object,
            notify:true,
            observer:'_setConfig'
          },
          /**
           * container for the data object that drives the thresholds
           * Generally loaded with an iron-ajax tag (but doesnt have to be)
           * This can be set declaratively
           *
           * @property thresholdData
           * @type Object
           */
          thresholdData:{
            type: Array,
            notify: true
          },
          /**
           * container for the data object that drives the events
           * Generally loaded with an iron-ajax tag (but doesnt have to be)
           * This can be set declaratively
           *
           * @property eventData
           * @type Object
           */
          eventData:{
            type: Array,
            notify: true
          },
          /**
           * Boolean to turn the on-chart tooltip on or off
           *
           * @property enableTooltip
           * @type Boolean
           */
          enableTooltip: {
            type: Boolean,
            notify: true,
            value: false
          }
        },


        ready:function(){
          this._calcMargins();
        },
        /**
         * Cycles through the Configuration object and sets each property. Triggers each components declarative binding
         *
         * @method _setConfig
         */
        _setConfig: function(){
          if(typeof(this.options) !== 'object'){
            console.error('Configuration options must be valid JSON');
            return;
          }

          var keys = Object.keys(this.options);
          for(var i = 0; i < keys.length; i++){
            var key = keys[i]
            this.set(key, this.options[key]);
          }
        },
        /**
         * Overwrites default margins based on settings
         *
         * @method _calcMargins
         */
        _calcMargins:function(){
          var topMargin = 25,
              rightMargin = 10,
              bottomMargin = 10,
              leftMargin = 10;

          if(this.xAxisLocation === 'bottom'){
            bottomMargin = 40;
          } else if(this.xAxisLocation === 'top'){
            topMargin = 40;
          }

          // TODO if multiple Y...
          if(this.yAxisLocation === 'left'){
            leftMargin = 50;
          } else if(this.yAxisLocation === 'right'){
            rightMargin = 40;
          }

          this.set('margin', {
            'top': topMargin,
            'right': rightMargin,
            'bottom': bottomMargin,
            'left': leftMargin
          });
          this.set('marginNav', {
            'top': 5,
            'right': rightMargin,
            'bottom': 20,
            'left': leftMargin
          });
        }
    });
</script>
